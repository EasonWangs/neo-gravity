<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>模拟引力环境下的撞击、摩擦、落体运动</title>
<style type="text/css">
	*{padding:0;margin:0;}
	html,body{height:100%;overflow:hidden;}
	p{margin:2px;font-size:12px;}
	label{display:inline-block;width:80px;text-align:right;}
	input{width:80px;}
	#canvas{
		position: absolute;
		top: 0;
		left: 0;
		background: #fff;
	}
	.controls {
		position: absolute;
		z-index: 1;
		background: rgba(255,255,255,0.8);
		padding: 10px;
	}
</style>
<script type="text/javascript" charset="utf-8" src="gravity.js"></script>
</head>
<body>
<div class="controls">
	<p><label>横向初速度：</label><input id="Vx" type="text" value="3" />px/ms</p>
	<p><label>纵向初速度：</label><input id="Vy" type="text" value="0" />px/ms</p>
	<p><label>重力加速度：</label><input id="a" type="text" value="0.01" />px/平方ms</p>
	<p><label>单位时间：</label><input id="t" type="text" value="10" />（记录运动的时间间隔）
	<p><label>摩擦系数：</label><input id="friction" type="text" value="0.005" />（底部摩擦损耗）</p>
	<p><label>垂直损耗：</label><input id="verticalLoss" type="text" value="0.2" />（垂直碰撞能量损耗）</p>
	<p><label>水平损耗：</label><input id="horizontalLoss" type="text" value="0.2" />（水平碰撞能量损耗）</p>
	<p><label>启用反馈：</label><input id="feedback" type="checkbox" checked />（震动和声音）</p>
	<p>
		<button type="button" id="demoBtn">演示</button>
		<button type="button" id="resetBtn">重置</button>
	</p>
</div>
<canvas id="canvas"></canvas>
<script type="text/javascript">
const $id = id => document.getElementById(id);

// 初始化 canvas
initCanvas();

// 改为 var 声明以便全局访问
var demo = () => {
	// 确保在用户交互时创建 AudioContext
	try {
		if (!audioContext) {
			audioContext = new (window.AudioContext || window.webkitAudioContext)();
		}
		// 如果 AudioContext 被挂起，则恢复它
		if (audioContext.state === 'suspended') {
			audioContext.resume();
		}
	} catch (e) {
		console.log('Web Audio API not supported');
	}

	const params = {
		x: $id('Vx').value,
		y: $id('Vy').value,
		a: $id('a').value,
		t: $id('t').value,
		friction: $id('friction').value,
		verticalLoss: $id('verticalLoss').value,
		horizontalLoss: $id('horizontalLoss').value
	};
	shoot(params.x, params.y, params.a, params.t, params.friction, params.verticalLoss, params.horizontalLoss);
};

// 添加事件监听
document.getElementById('demoBtn').addEventListener('click', demo);
document.getElementById('resetBtn').addEventListener('click', () => {
	// 停止当前动画
	if (animationId) {
		cancelAnimationFrame(animationId);
		animationId = null;
	}
	// 重置位置
	ballPosition.x = 400;
	ballPosition.y = 50;
	// 清除画布
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	// 绘制小球
	drawBall(ballPosition.x, ballPosition.y);
});

// 拖拽功能
let isDragging = false;
let dragOffset = { x: 0, y: 0 };

canvas.addEventListener('mousedown', (e) => {
	const rect = canvas.getBoundingClientRect();
	const x = e.clientX - rect.left;
	const y = e.clientY - rect.top;
	
	// 检查是否点击到小球
	if (Math.hypot(x - ballPosition.x, y - ballPosition.y) <= 10) {
		isDragging = true;
		dragOffset.x = x - ballPosition.x;
		dragOffset.y = y - ballPosition.y;
	}
});

canvas.addEventListener('mousemove', (e) => {
	if (!isDragging) return;
	
	const rect = canvas.getBoundingClientRect();
	ballPosition.x = e.clientX - rect.left - dragOffset.x;
	ballPosition.y = e.clientY - rect.top - dragOffset.y;
	
	// 清除画布并重绘小球
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	drawBall(ballPosition.x, ballPosition.y);
});

canvas.addEventListener('mouseup', () => {
	isDragging = false;
});
</script>
</body>
</html>