<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="initial-scale=1.0, width=device-width" />
<title>模拟引力环境下的撞击、摩擦、落体运动</title>
<style type="text/css">
	*{padding:0;margin:0;}
	html,body{height:100%;overflow:hidden;}
	#canvas{
		position: absolute;
		top: 0;
		left: 0;
		background: #fff;
	}
</style>
<script type="text/javascript" charset="utf-8" src="gravity.js"></script>
<script type="text/javascript" charset="utf-8" src="drag.js"></script>
</head>
<body>
<canvas id="canvas"></canvas>
<script type="text/javascript">
const $id = id => document.getElementById(id);

// 初始化 canvas
initCanvas();
// 初始化拖拽功能
initDrag(canvas);

// 设置晃动检测相关变量
let lastX = 0;
let lastY = 0;
let lastZ = 0;
let moveCounter = 0;
let shakeThreshold = 15; // 晃动阈值，可根据需要调整
let lastShakeTime = 0;
let minTimeBetweenShakes = 500; // 两次晃动之间的最小时间间隔（毫秒）

// 检查设备是否支持 DeviceMotion 事件
if (window.DeviceMotionEvent) {
    // 在某些浏览器（如 iOS 13+）中，需要请求权限
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        // 添加一个按钮来请求权限
        const button = document.createElement('button');
        button.innerText = '允许访问动作传感器';
        button.style.position = 'absolute';
        button.style.zIndex = '1000';
        button.style.top = '10px';
        button.style.left = '10px';
        button.style.padding = '10px';
        document.body.appendChild(button);
        
        button.addEventListener('click', function() {
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('devicemotion', handleMotion);
                        button.style.display = 'none';
                    }
                })
                .catch(console.error);
        });
    } else {
        // 对于其他浏览器，直接添加事件监听器
        window.addEventListener('devicemotion', handleMotion);
    }
} else {
    console.log('设备不支持 DeviceMotion 事件');
}

// 处理设备运动事件
function handleMotion(event) {
    const currentTime = new Date().getTime();
    
    // 获取加速度数据（包括重力）
    const acceleration = event.accelerationIncludingGravity;
    
    if (!acceleration) return;
    
    const x = acceleration.x;
    const y = acceleration.y;
    const z = acceleration.z;
    
    // 计算加速度变化
    const deltaX = Math.abs(x - lastX);
    const deltaY = Math.abs(y - lastY);
    const deltaZ = Math.abs(z - lastZ);
    
    // 更新上一次的加速度值
    lastX = x;
    lastY = y;
    lastZ = z;
    
    // 检测晃动
    if ((deltaX > shakeThreshold && deltaY > shakeThreshold) || 
        (deltaX > shakeThreshold && deltaZ > shakeThreshold) || 
        (deltaY > shakeThreshold && deltaZ > shakeThreshold)) {
        
        // 确保两次晃动之间有足够的时间间隔
        if (currentTime - lastShakeTime > minTimeBetweenShakes) {
            lastShakeTime = currentTime;
            
            // 使用加速度作为初速度（可以根据需要调整系数）
            const velocityX = x * 2;
            const velocityY = y * 2;
            
            // 应用晃动产生的初速度
            applyShakeVelocity(velocityX, velocityY);
        }
    }
}

// 应用晃动产生的初速度到物体
function applyShakeVelocity(vx, vy) {
    console.log('应用晃动初速度:', vx, vy);
    
    // 假设您的物理引擎中有一个函数可以设置物体的初速度
    if (typeof setObjectVelocity === 'function' && currentSelectedObject) {
        setObjectVelocity(currentSelectedObject, vx, vy);
    }
}
</script>
</body>
</html>